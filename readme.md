# Data transfer

# Data

## Data download
### 1. Download the data
### 2. put the data under the tree:

 - Emma's path: rds/rds-t2-cs138-LlrDsbHU5UM/sw991/Project_AD/data/ADNI-rawdata/ADNI2/Month0

 - Updated path: rds/rds-cam-psych-abl-2T20izN5fjc/Data/HyperGraph/data/ADNI2/Month0

 > ***(If you want to do pre-processing yourself, please reminder to check the path difference in the code by replacing these two paths.)***

        - ADNI2
                - Month0 (containing screening and baseline with python file copy2Month0.py)
                        - MRI
                                - Patient ID
                                        - Axial_T2-Star (dcm files)
                                - generated .nii file from .dcm
                        - PET
                                - Patient ID
                                        - Axial_T2-Star (dcm files)
                                - generated .nii file from .dcm
                - Month3
                - Month6
                - Year1
                - Year2


## Data Preprocessing

### 1. transfer the .dcm data (downloaded from the ADNI official website) into .nii data (for better processing)
 - Emma's path: rds/rds-t2-cs138-LlrDsbHU5UM/sw991/Project_AD/data/ADNI-rawdata/scripts

 - Updated path: rds/rds-cam-psych-abl-2T20izN5fjc/Data/HyperGraph/code/script_pre_processing
```  rds/rds-t2-cs138-LlrDsbHU5UM/sw991/Project_AD/data/ADNI-rawdata/scripts
python organise_the_data-info10.py transfer
```

### 2. list all the transferred image names (end with .nii) for preprocessing
```
python organise_the_data-info10.py list for_pre_processing
```
It will generate two .csv files named 'MRI_filelist_for_pre_processing.csv' and 'PET_filelist_for_pre_processing.csv'.
I rename them to MRI_filelist.csv and PET_filelist.csv, which are stored in rds/rds-cam-psych-abl-2T20izN5fjc/Data/HyperGraph/code/script_pre_processing


### 3. using matlab scripts for pre-processing shared from Georgios. (spm12 install required.)

 The main script is 'process_pet_mni.m'.
 - Emma's path: 'rds/rds-t2-cs138-LlrDsbHU5UM/sw991/Project_AD/data/ADNI-from-Zoe/GeorgiosPET_MRI/pre_processing_functions'
 - Updated path: rds/rds-cam-psych-abl-2T20izN5fjc/Data/HyperGraph/code/script_pre_processing

 Just run the 'process_pet_mni.m' in MATLAB after changing all the path locations. I have indicated them within 'process_pet_mni.m'.

 It can help you finish all the pre-processing task except segmentation task.

 For the segmentation, two scripts are needed: segment_job.m and segment.m.
 - Emma's path: rds/rds-t2-cs138-LlrDsbHU5UM/sw991/Project_AD/data/ADNI-from-Zoe/GeorgiosPET_MRI/pre_processing_functions/Emma-preprocessing
 - Updated path: rds/rds-cam-psych-abl-2T20izN5fjc/Data/HyperGraph/code/script_pre_processing

  > 'segment_job.m' contains all the image names that need to be processed.
 >
 > 'segment.m' contains the command how to do segmentation.

 I process them by batch (divide all the image samples into 10 parts. Do it ten times.)
 Just run segment.m within MATLAB after changing all the path location.

 After the pre-processing, we will got many internal and final images (begin with 'SS/sS') with different prefix.


### 4. list all the image names after preprocessing

 ```
 python organise_the_data-info10.py list after_pre_processing
 ```
 It will generate 'MRI_filelist_after_pre_processing.csv' and PET_filelist_after_pre_processing.csv

 - Emma's path: rds/rds-t2-cs138-LlrDsbHU5UM/sw991/Project_AD/data/ADNI-rawdata/
 - Updated path: rds/rds-cam-psych-abl-2T20izN5fjc/Data/HyperGraph/code/script_pre_processing

 'MRI_filelist_after_pre_processing.csv' contains the path of MRI data [Month0, Month3, Month6, Year1, Year2], but only Month0 data is utilised for the following procedures.

  > Example:
  023_S_2068,I260645,MRI,Month0,./ADNI2/Month0/MRI/023_S_2068/SS_r5_axial_t2_star.nii

 'rds/rds-t2-cs138-LlrDsbHU5UM/sw991/Project_AD/data/ADNI-rawdata/PET_filelist_after_pre_processing.csv' is similar to MRI procedure.


### 5. To generate the input data to feed into the deep neural network.

 - Emma's path: rds/rds-t2-cs138-LlrDsbHU5UM/sw991/Project_AD/data/ADNI-rawdata/scripts/
 - Updated path: rds/rds-cam-psych-abl-2T20izN5fjc/Data/HyperGraph/code/script_pre_processing

 Data information is contained in
train_info10.csv   test_info10.csv
train_split10.pkl  test_split10.pkl

 > info10 80% training 20% Testing with seed = 30

 '.csv' contains the label information and non-imaging data: PTID,RID,VISCODE,mri,pet,DX_bl,DX,AGE,PTGENDER,PTEDUCAT,APOE4,MMSE,RAVLT_immediate,RAVLT_learning,RAVLT_forgetting,RAVLT_perc_forgetting,ADNI_MEM,ADNI_EF
 '.pkl' contains the path of training images. stored in a dictionary way.

 '.pkl' is generated by
 ```  rds/rds-t2-cs138-LlrDsbHU5UM/sw991/Project_AD/data/ADNI-rawdata/scripts
python organise_the_data-info10.py split
```
 '.csv' is generated by (ADNIMERGE.csv is utilized to retrival the information)
 ```  rds/rds-t2-cs138-LlrDsbHU5UM/sw991/Project_AD/data/ADNI-rawdata/scripts
python organise_the_data_get_label_non_clinical_information_filelist.py getinfo 10
```


# Code
## location
will update after cleaning code

## Install environment

```
conda create -n HGIB python=3.7.13
conda activate HGIB
pip install -r requirements.txt
conda install pytorch torchvision cudatoolkit=11.1 -c pytorch-lts -c nvidia
pip install torchmetrics==0.10.0
```

## Run HGIB


### Testing command
```
python test.py --gpu_ids 0, --name HGIB --netD fc --focal --model single_time_multi_modality_classification_HGIB --label_time m24 --onefc --control MCI --K_neigs 20 --load_weight HGIB --split 10

```

### Training command for your own setting you can change the the name
```python
python train.py --gpu_ids 0, --lr 0.0001 --name HGIB/name --netD fc --focal --model single_time_multi_modality_classification_HGIB --label_time m24 --onefc --control MCI --K_neigs 20 --continue_train --load_weight non_image/complete-modality-info10 --niter 0 --niter_decay 2000  --beta 10 --split 10
```
### Testing command for your own setting you can change the the name and load_weight

```python
python test.py --gpu_ids 0, --name HGIB/name --netD fc --focal --model single_time_multi_modality_classification_HGIB --label_time m24 --onefc --control MCI --K_neigs 20 --load_weight HGIB/name --split 10

```
